<div class="alert alert-info">
    <strong>Another covid-19 dashboard</strong>
</div>

<div class="range-container">
    <label for="outbreak-threshold">Outbreak</label>
    <div>
        <input type="range" id="outbreak-threshold" value="20">
    </div>
</div>

<div class="range-container">
    <label for="day-range">Show days since outbreak:</label>
    <div>
        <input type="range" id="day-range"  max="25"/>
    </div>
</div>

<div>
    <input class="refresh" type="checkbox"  id="log-switch" value="off">
    <label for="log-switch">Log scale</label>
</div>


<canvas id="chart"></canvas>


<script>
    // definitions
    var setup = {};
    var source = {};
    var chart = null; // chart instance
    let url = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv';
    let ready_to_refresh = false;



    $(function () {
        // DOM configuration
        $("#outbreak-threshold").ionRangeSlider({
            skin: "big",
            //type: "double",
            grid: true,
            min: 0,
            max: 50
                    //from: setup["outbreak-threshold"]
        });


        $("#day-range").ionRangeSlider({
            skin: "big",
            type: "double",
            grid: true,
            min: 0,
            max: 25, //XX setup["day-range"][1],
            to: 25, //XXsetup["day-range"][1],
            from: 0
        });

        // refresh on input change
        $("input:not(.irs-hidden-input)").change(refresh); // every normal input change
        $("input.irs-hidden-input").each(function () { // sliders
            let opt = $(this).data("ionRangeSlider").options;
            opt.onFinish = refresh;
            // do not change window hash when moving input slider
            opt.onChange = () => {
                refresh(false);
            };
        });


        // document events
        window.addEventListener('hashchange', load_hash, false);
        refresh_setup(true);


// runtime
        $.get(url, (data) => {
            source = data;
            refresh(set_ready = true);

            // draw territories
            let $territories = $("#territories tbody");
            let td = (col_id, storage) => {
                let text = [];
                for (let o of Object.values(storage)) {
                    text.push(o.get_html());
                }
                $("td:eq(" + col_id + ")", $territories).html(text.join(""));
            };
            td(0, Territory.states);
            td(1, Territory.countries);
            $("td", $territories).on("click", "> div", function (event) {
                let t = Territory.get_id($(this).attr("id"));
                if (event.target === $("span:eq(0)", $(this))[0]) { // hide/show all
                    t.toggle_children_visibility();
                } else if (event.target === $("span:eq(1)", $(this))[0]) { // un/check all
                    t.toggle_children_checked();
                } else if (event.target.type !== "checkbox") { // toggle clicked territory
                    $("input:checkbox", $(this)).click();
                } else if ($(event.target).prop("checked")) {
                    t.check();
                } else {
                    t.uncheck();
                }
            });

        });
        //return;

    });






    /**
     *
     * @param {type} data Raw data from github
     * @returns {Array} Sorted by chosen countries.
     */
    function filterCountries(csv) {
        let country_data = {};   // countries with outbreak
        let lines = csv.split("\n");

        let headers = lines[0].split(",");
        for (let i = 1; i < lines.length; i++) {
            let line = lines[i].split(",");

            line = splitCsv(lines[i]);
            let name = line[0] || line[1];

            let t = Territory.get(line[1], Territory.COUNTRY);
            if (line[0]) {
                t.add_child(line[0], Territory.STATE);
            }

            if (european_countries.indexOf(name) < 0) { // include only specific countries
                continue;
            }

            let outbreak_data = [];
            let ignore = true;
            for (let j = 4; j < headers.length; j++) {
                if (line[j] >= setup["outbreak-threshold"]) { // append the data starting with threshold
                    ignore = false;
                }
                if (!ignore) {
                    outbreak_data.push(line[j]);
                }
//                obj[headers[j]] = line[j];
            }

            //country = {}
            //datas= pandas.DataFrame.from_dict(country, orient='index').transpose()


            country_data[name] = outbreak_data;

        }
        return country_data;
    }


    function load_hash() {
        try {
            setup = JSON.parse(decodeURI(window.location.hash.substr(1)));
        } catch (e) {
            return;
        }
        for (let key in setup) {
            let $el = $("#" + key);
            if (!key in setup) {
                continue;
            }
            let val = setup[key];
            if ((r = $el.data("ionRangeSlider"))) {
                if (r.options.type === "double") {
                    r.update({from: val[0], to: val[1]});
                } else {
                    r.update({from: val});
                }
            } else if ($el.attr("type") === "checkbox") {
                $el.prop("checked", val);
            } else {
                $el.val(val);
            }
        }
        refresh();
    }


    function refresh_setup(load_from_hash = false, allow_window_hash_change = true) {
        $("input").each(function () {
            // Load value from the $el to setup.
            $el = $(this);
            let key = $el.attr("id");
            let val;
            if ((r = $el.data("ionRangeSlider"))) {
                if (r.options.type === "double") {
                    val = [r.result.from, r.result.to];
                } else {
                    val = r.result.from;
                }
            } else if ($el.attr("type") === "checkbox") {
                val = $el.prop("checked") ? 1 : 0;
            } else {
                val = $el.val();
            }
            setup[key] = val;
        });

        if (load_from_hash) {
            load_hash();

        } else if (allow_window_hash_change) {
            window.location.hash = JSON.stringify(setup);
    }
    }

    function init_chart() {
        let ctx = $("#chart");
        chart = new Chart(ctx, {
            type: 'line',
            data: {},
            options: {
                tooltips: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true
                            }
                        }],
                    yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Total confirmed cases'
                            },
                            ticks: {
                                callback: function (value, index, values) {
                                    return Number(value.toString());
                                }
                            }
                        }]
                }
            }
        });
    }


    /**
     *
     * @param {bool|Event} event True -> make refresh possible further on. False -> refresh but do not change window hash (would stop slider movement). Event -> callback from an input change, no special action.
     * @returns {Boolean}
     */
    function refresh(event = null) {
        // pass only when ready
        if (event === true) {
            ready_to_refresh = true;
        }
        if (!ready_to_refresh) {
            return false;
        }

        refresh_setup(false, event !== false);

        // build chart data
        let chart_data = {datasets: []};

        // process each country
        let longest_data = 0;
        let countries = filterCountries(source);
        let datasets = {};
        for (let country in countries) {
            // choose only some days in range
            let chosen_data = [];
            for (let i = setup["day-range"][0]; i < countries[country].length && i < setup["day-range"][1]; i++) {
                chosen_data.push(countries[country][i]);
            }

            longest_data = Math.max(longest_data, chosen_data.length);

            // push new dataset
            let dataset = {
                type: 'line',
                borderColor: "#" + intToRGB(hashCode(country)), //"#5793DB",
                label: country,
                data: chosen_data,
                borderWidth: 3,
                fill: false,
                backgroundColor: "#" + intToRGB(hashCode(country)), //"#5793DB",
            };
            datasets[country] = dataset;
            chart_data.datasets.push(dataset);


        }
        chart_data.labels = range(setup["day-range"][0], Math.min(longest_data, setup["day-range"][1])).map(String);

        // update chart data
        if (!chart) {
            init_chart();
            chart.data = chart_data;
        } else {
            // update just some datasets, do not replace them entirely (smooth movement)
            chart.data.labels = chart_data.labels;
            let removable = [];
            // update changed
            for (let o of chart.data.datasets) {
                if (o.label in datasets) {
                    o.data = datasets[o.label].data;
                    delete datasets[o.label];
                } else {
                    removable.push(o);
                }
            }
            // remove unused
            chart.data.datasets.filter((el) => !removable.includes(el));
            // insert new
            Object.values(datasets).map(chart.data.datasets.push);
        }
        chart.options.scales.xAxes[0].scaleLabel.labelString = `Days count since >= ${setup["outbreak-threshold"]} confirmed cases`;
        chart.options.scales.yAxes[0].type = setup["log-switch"] ? "logarithmic" : "linear";
        chart.update();
    }


</script>

Source: <a href="https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data">Johns Hopkins CSSE</a> (data updated once a day)
<br>
Help development at <a href="https://github.com/e3rd/covid-19/tree/master/static">github</a>.


<table id="territories">
    <thead>
        <tr><th>State</th><th>Region</th><th>Continent</th></tr>
    </thead>
    <tbody>
        <tr>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </tbody>
</table>
